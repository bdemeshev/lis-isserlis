% arara: xelatex
\documentclass[12pt]{article}

% \usepackage{physics}

\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan,
    pdftitle={Overleaf Example},
    pdfpagemode=FullScreen,
    }

\usepackage{verse}

\usepackage{tikzducks}

\usepackage{tikz} % картинки в tikz
\usetikzlibrary{shapes, arrows, positioning}
\usepackage{microtype} % свешивание пунктуации

\usepackage{array} % для столбцов фиксированной ширины

\usepackage{indentfirst} % отступ в первом параграфе

\usepackage{sectsty} % для центрирования названий частей
\allsectionsfont{\centering}

\usepackage{amsmath, amsfonts, amssymb} % куча стандартных математических плюшек

\usepackage{comment}

\usepackage[top=2cm, left=1.2cm, right=1.2cm, bottom=2cm]{geometry} % размер текста на странице

\usepackage{lastpage} % чтобы узнать номер последней страницы

\usepackage{enumitem} % дополнительные плюшки для списков
%  например \begin{enumerate}[resume] позволяет продолжить нумерацию в новом списке
\usepackage{caption}

\usepackage{url} % to use \url{link to web}


\newcommand{\smallduck}{\begin{tikzpicture}[scale=0.3]
    \duck[
        cape=black,
        hat=black,
        mask=black
    ]
    \end{tikzpicture}}

\usepackage{fancyhdr} % весёлые колонтитулы
\pagestyle{fancy}
\lhead{}
\chead{Хитрый Лис Иссерлис}
\rhead{}
\lfoot{}
\cfoot{}
\rfoot{}

\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}

\usepackage{tcolorbox} % рамочки!

\usepackage{todonotes} % для вставки в документ заметок о том, что осталось сделать
% \todo{Здесь надо коэффициенты исправить}
% \missingfigure{Здесь будет Последний день Помпеи}
% \listoftodos - печатает все поставленные \todo'шки


% более красивые таблицы
\usepackage{booktabs}
% заповеди из докупентации:
% 1. Не используйте вертикальные линни
% 2. Не используйте двойные линии
% 3. Единицы измерения - в шапку таблицы
% 4. Не сокращайте .1 вместо 0.1
% 5. Повторяющееся значение повторяйте, а не говорите "то же"


\setcounter{MaxMatrixCols}{20}
% by crazy default pmatrix supports only 10 cols :)


\usepackage{fontspec}
\usepackage{libertine}
\usepackage{polyglossia}

\setmainlanguage{russian}
\setotherlanguages{english}

% download "Linux Libertine" fonts:
% http://www.linuxlibertine.org/index.php?id=91&L=1
% \setmainfont{Linux Libertine O} % or Helvetica, Arial, Cambria
% why do we need \newfontfamily:
% http://tex.stackexchange.com/questions/91507/
% \newfontfamily{\cyrillicfonttt}{Linux Libertine O}

\AddEnumerateCounter{\asbuk}{\russian@alph}{щ} % для списков с русскими буквами
% \setlist[enumerate, 2]{label=\asbuk*),ref=\asbuk*}

%% эконометрические сокращения
\DeclareMathOperator{\Cov}{\mathbb{C}ov}
\DeclareMathOperator{\Corr}{\mathbb{C}orr}
\DeclareMathOperator{\Var}{\mathbb{V}ar}
\DeclareMathOperator{\col}{col}
\DeclareMathOperator{\row}{row}

\let\P\relax
\DeclareMathOperator{\P}{\mathbb{P}}

\DeclareMathOperator{\E}{\mathbb{E}}
% \DeclareMathOperator{\tr}{trace}
\DeclareMathOperator{\card}{card}
\DeclareMathOperator{\mgf}{mgf}

\DeclareMathOperator{\Convex}{Convex}
\DeclareMathOperator{\plim}{plim}

\usepackage{mathtools}
\DeclarePairedDelimiter{\norm}{\lVert}{\rVert}
\DeclarePairedDelimiter{\abs}{\lvert}{\rvert}
\DeclarePairedDelimiter{\scalp}{\langle}{\rangle}
\DeclarePairedDelimiter{\ceil}{\lceil}{\rceil}

\newcommand{\cN}{\mathcal{N}}
\newcommand{\cF}{\mathcal{F}}

\newcommand{\RR}{\mathbb{R}}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\hb}{\hat{\beta}}
\newcommand{\dPois}{\mathrm{Pois}}





\begin{document}


\begin{verse}
    \begin{flushright}
        — Что мы знаем о лисе? \\
        — Ничего. И то не все. \\

        Борис Заходер
    \end{flushright}
\end{verse}

Цель этой заметки — доказать теорему Иссерлиса о подсчёте ожиданий для многомерного нормального распределения.
По дороге выведем функцию производящую моменты для одномерного нормального $\cN(\mu, \sigma^2)$ и многомерного нормального $\cN(\mu, C)$.

\begin{tcolorbox}[colback=yellow!50!red!25!white]
    Если $Y \sim \cN(\mu, C)$, то
    \[
    \E(Y_1) = \mu_1
    \]
    \[
    \E(Y_1 Y_2) = \mu_1 \mu_2 + c_{12}
    \]
    \[
        \E(Y_1 Y_2 Y_3) = \mu_1 \mu_2 \mu_3 + \mu_1 c_{23} + \mu_2 c_{13} + \mu_3 c_{12}.
    \]
    \[
        \E(Y_1 Y_2 Y_3 Y_4) = \mu_1 \mu_2\mu_3 \mu_4 + \mu_1 \mu_4 c_{23} + \mu_2 \mu_4 c_{13} + \mu_3 \mu_4 c_{12} + \mu_1 \mu_3 c_{24} + \mu_1 \mu_2 c_{34} + \mu_2 \mu_3 c_{14} +  c_{12}c_{34} + c_{13}c_{24} + c_{14}c_{23}.
    \]
    Каждое слагаемое идёт с единичным весом.
    Каждое слагаемое содержит все индексы от единицы до максимального ровно по одному разу. 
    Все варианты перемножения $\mu_i$ и $c_{jk}$ присутствуют. 
    Множитель $\mu_i$ «съедает» один индекс, а $c_{jk}$ «съедает» два индекса. 
    \end{tcolorbox}

\section*{Почти доказательство}

Если вектор $Y$ имеет нормальное распределение $\cN(\mu, C)$, то $\E(Y_1) = \mu_1$ и $\E(Y_1 Y_2) = \mu_1 \mu_2 + c_{12}$.

А как выглядят ожидания $\E(Y_1 Y_2 Y_3)$, $\E(Y_1 Y_2 Y_3 Y_4)$ и так далее?

Конечно, они должны быть функциями от ожиданий $\mu_i$ и ковариаций $c_{jk}$, так как эти параметры полностью описывают многомерное нормальное распределение. 

Поглядев на $\E(Y_1)$ и $\E(Y_1 Y_2)$ мы видим, что эти функции являются многочленами от $\mu_i$ и $c_{jk}$.
Давайте предположим, что и дальнейшие ожидания тоже будут многочленами.

Конечно, произвольный многочлен может содежать слагаемые в духе $\mu_1^2 \mu_3^4 c_{15} c_{27}^3 c_{29}^9$.
Однако $\E(Y_1 Y_2 Y_3)$ должно быть линейно по $Y_1$. 
Например, при увеличении $Y_1$ в два раза двойка должна выноситься из каждого слагаемого многочлена!
При увеличении $Y_1$ в два раза во столько же раз растут ожидание $\mu_1$ и ковариации $c_{12}$, $c_{13}$.
Значит каждое слагаемое многочлена должно содержать ровно одну из этих величин в качестве сомножителя.
Например, слагаемое $\mu_1 c_{12} \mu_3$ невозможно, так как растёт в $4$ раза при увеличении $Y_1$ в два раза.

Аналогично рассуждая про $Y_2$ и $Y_3$ мы понимаем, что в каждом слагаемом каждый индекс от $1$ до $3$ должен быть упомянут ровно один раз.
\[
\E(Y_1 Y_2 Y_3) = ? \mu_1 \mu_2 \mu_3 + ? \mu_1 c_{23} + ? \mu_2 c_{13} + ? \mu_3 c_{12}.
\]
Более того, формула должна быть симметричной, а именно, должна сохранятся при смене индексов. 
Коэффициенты при $\mu_1 c_{23}$, $\mu_2 c_{13}$ и $\mu_3 c_{12}$ должны совпадать.
% здесь у меня была ошибка, что все ненулевые коэффициенты должны быть равны для возможности выносить общий множитель.

Также можно было рассуждать по размерностям, если $Y_1$ измеряется в пудах, $Y_2$ — в вершках, а $Y_3$ — в саженях, 
то каждое слагаемое многочлена должно иметь такие же единицы измерения, $[\text{пуд}\times \text{вершок} \times\text{сажень}]$. 
А слагаемые, где какой-то индекс повторяется имеют неподходящие единицы измерения. 
Например, $\mu_2 c_{23}$ измеряется в $[\text{вершок}^2 \times\text{сажень}]$. 

Начнём охоту за коэффициентами многочлена! Занулим все слагаемые кроме $\mu_1 \mu_2 \mu_3$.
Для этого возьмём независимые $Y_1 \sim \cN(1, 1)$, $Y_2\sim \cN(1, 1)$ и $Y_3\sim \cN(1, 1)$.
С одной стороны для них $\E(Y_1 Y_2 Y_3) = 1$. 
В многочлене при этом остаётся лишь слагаемое $\mu_1 \mu_2 \mu_3$,
следовательно, коэффициент при нём равен $1$.

Теперь занулим все слагаемые кроме $\mu_1 c_{23}$.
Для этого возьмём $Y_1 \sim \cN(1, 1)$, $Y_2 = Y_3 \sim \cN(0, 1)$ и независимы от $Y_1$.
В этом случае $\E(Y_1 Y_2 Y_2) = 1 \cdot 1$ и коэффициент при слагаемом $\mu_1 c_{23}$ также равен $1$.

Итого мы получили, что все возможные слагаемые присутствуют с весом $1$,
\[
    \E(Y_1 Y_2 Y_3) = \mu_1 \mu_2 \mu_3 + \mu_1 c_{23} + \mu_2 c_{13} + \mu_3 c_{12}.
\]
Для следующего ожидания $\E(Y_1 Y_2 Y_3 Y_4)$ сработают аналогичные рассуждения. 
Во-первых, чтобы сохранялась линейность по отдельным $Y_i$ ни одно слагаемое не может иметь повторяющихся индексов.
Во-вторых, все коэффициенты многочлена равны единице. 
Например, чтобы посмотреть в новом многочлене на коэффициент при слагаемом $c_{12}c_{34}$ нужно взять $Y_1 = Y_2 \sim \cN(0, 1)$ 
и независимую величину $Y_3 = Y_4 \sim \cN(0;1)$. 
А чтобы глянуть на коэффициент при $\mu_1 \mu_2 c_{34}$ нужно взять независимые $Y_1 \sim \cN(1;1)$, $Y_2 \sim \cN(1,1)$ и 
 $Y_3 = Y_4 \sim \cN(0;1)$. 
Единственно возможный вариант,
\[
    \E(Y_1 Y_2 Y_3 Y_4) = \mu_1 \mu_2\mu_3 \mu_4 + \mu_1 \mu_4 c_{23} + \mu_2 \mu_4 c_{13} + \mu_3 \mu_4 c_{12} + \mu_1 \mu_3 c_{24} + \mu_1 \mu_2 c_{34} + \mu_2 \mu_3 c_{14} +  c_{12}c_{34} + c_{13}c_{24} + c_{14}c_{23}.
\]



Пример.

Вектор $Y$ имеет совместное нормальное распределение,
\[
\begin{pmatrix}
    Y_1 \\
    Y_2 \\
    Y_3 \\
\end{pmatrix} \sim \cN\left(
\begin{pmatrix}
    1 \\
    2 \\
    3 \\
\end{pmatrix},
\begin{pmatrix}
    5 & -1 & -2 \\
    -1 & 6 & -3 \\
    -2 & -3 & 7 \\
\end{pmatrix}
\right).
\]

Найдите $\E(Y_1 Y_2 Y_3)$ и $\E(Y_1 Y_2 Y_2)$.


Решение:
\[
    \E(Y_1 Y_2 Y_3)  = \mu_1 \mu_2\mu_3 + \mu_1 c_{23} + \mu_2 c_{13} + \mu_3 c_{12} = 1\cdot 2 \cdot 3 + 1 \cdot (-3) + 2 \cdot (-2) + 3\cdot (-1) = -2.
\]

Если какой-то индекс повторяется, то его надо повторить :)
\[
    \E(Y_1 Y_2 Y_2) = \mu_1 \mu_2\mu_2 + \mu_1 c_{22} + \mu_2 c_{12} + \mu_2 c_{12}.
\]



Всё! Доказательство опирается на допущение, что $\E(Y_1 Y_2 \dots Y_n)$ является многочленом от $\mu_i$ и $c_{jk}$ для нормального распределения.
Для других распределений это не верно. 
В оставшейся части мы залатаем это предположение доказав теорему Иссерлиса через производящие функции. 


\section*{Одномерная функция производящая моменты}
Первая задача. 
Найдите функцию производящую моменты $\mgf(u) = \E(\exp(uX))$ для нормальной $X \sim \cN(0; 1)$.

Перейдём к интегралам!
\[
\E(\exp(u X)) = \int_{\RR} \exp(u x) f(x) dx = \int_{\RR} \exp(u x) \frac{1}{\sqrt{2\pi}} \exp(-x^2/2) dx.
\]
Для взятия интеграла выделим полный квадрат внутри экспоненты:
\[
u x - x^2/2 = -\frac{1}{2} (x^2 - 2u x  + u^2 - u^2) = -\frac{1}{2} (x - u)^2 + \frac{1}{2} u^2.
\]
Возвращаемся к интегралу:
\[
\E(\exp(u X)) = \dots = \int_{\RR} \exp(u^2/2) \frac{1}{\sqrt{2\pi}} \exp(-(x- u)^2/2) dx = \exp(u^2/2) \int_{\RR} \frac{1}{\sqrt{2\pi}} \exp(-(x- \sigma)^2/2) dx.
\]
Замечаем, что последний интеграл — это площадь под нормальной функцией плотности, смещённой на $u$ вправо. 
И эта площадь равна единице. 

Задача раз решена,
\[
    \E(\exp(uX)) = \exp(u^2/2) 
\]


Вторая задача. 
Найдите функцию производящую моменты $\mgf_Y(u) = \E(\exp(uY))$ для нормальной $Y \sim \cN(\mu; \sigma^2)$.

Сначала стандартизируем $Y$, $Y = \mu + \sigma X$, где $X \sim \cN(0; 1)$:
\[
\E(\exp(uY)) = \E(\exp(u\mu)\exp(u\sigma X)) = \exp(u\mu) \E(\exp(u\sigma X)).
\]
Ожидание в конце мы уже де-факто считали, $\E(\exp(u\sigma X)) = \exp(u^2\sigma^2/2)$.

Отсюда 
\[
\mgf_Y(u) = \E(\exp(uY)) =\exp(\mu u + \sigma^2 u^2 /2), \text{ если } Y \sim \cN(\mu, \sigma^2).
\]

\section*{Многомерная функция производящая моменты}
Третья задача. 
Найдите функцию производящую моменты для случайного вектора $Y \sim \cN(\mu, C)$.

По-определению, $\mgf_Y(u) = \E(\exp(u^T Y))$.

Заметим, что $u^T Y$ это скалярная случайная величина с нормальным распределением $\cN(u^T \mu, u^T C u)$.

Снова быстро получаем функцию производящую моменты, 
\[
\mgf_Y(u) = \exp(u^T\mu + u^T C u/2).
\]
Производящая функция выглядит как экспоненты от квадратичной функции,
\[
\mgf_Y(u) = \exp(q(u)), \quad q(u) = u^T\mu + u^T C u/2.
\]

\section*{Доказательство через производящие функции}
Четвёртая задача. 
Для случайного вектора $Y \sim \cN(\mu, C)$ последовательно найдите $\E(Y_1)$, $\E(Y_1 Y_2)$, $\E(Y_1 Y_2 Y_3)$ и $\E(Y_1 Y_2 Y_3 Y_4)$.

Вспомним, что $\E(Y_1) = \mgf'_1(0)$, $\E(Y_1 Y_2) = \mgf''_{12}(0)$ и так далее. 

Немного заранее подготовимся! Во-первых, в нуле $q(0) = 0$, $\exp(q(0)) = 1$.

Найдём первую производную $q'_1(u) = \mu_1 + c_1^T u$, где $c_1$ — первый столбец матрицы $C$.
Для наглядности перепишем её в скалярном виде
\[
    q'_1(u_1, u_2, \dots, u_n) = \mu_1 + c_{11}u_1 + c_{12}u_2 + \dots + c_{1n}u_n.
\]
В нуле первая производная равна $q'_1(0) = \mu_1$ соответствующему ожиданию. 

Вторая производная $q''_{12}(u) = c_{12}$ тождественно равна соответствующей ковариации. 

Третья производная $q'''_{123} = 0$  тождественно равна нулю, ведь $q(u)$ — квадратичная функция.

А теперь считаем ожидания по очереди,
\[
    \E(Y_1) = \mgf'_1 = \exp(q) q'_1 = 1 \cdot \mu_1 = \mu_1.
\]
Пока что ничего неожиданного, мы же сами обозначили $\E(Y_1)$ как $\mu_1$.

Пойдём дальше!
\[
    \E(Y_1Y_2) = \mgf''_{12} = \exp(q) (q'_1q'_2 + q''_{12}) = \mu_1 \mu_2 + c_{12}.
\]
Это тождество, верное для любый случайных величин, не только для нормальных, $\E(Y_1 Y_2) = \E(Y_1) \E(Y_2) + \Cov(Y_1, Y_2)$.

Продолжаем,
\[
    \E(Y_1 Y_2 Y_3) = \mgf'''_{123} = \exp(q) (q'_1 q'_2 q'_3 + q'_3 q''_{12} + q'_1 q''_{23} + q'_2 q''_{13}) = \mu_1 \mu_2\mu_3 + \mu_1 c_{23} + \mu_2 c_{13} + \mu_3 c_{12}.
\]

Дифференцируя дальше убеждаемся в сохранении закономерности, 
\[
    \E(Y_1 Y_2 Y_3 Y_4) = \mu_1 \mu_2\mu_3 \mu_4 + \mu_1 \mu_4 c_{23} + \mu_2 \mu_4 c_{13} + \mu_3 \mu_4 c_{12} + \mu_1 \mu_3 c_{24} + \mu_1 \mu_2 c_{34} + \mu_2 \mu_3 c_{14} +  c_{12}c_{34} + c_{13}c_{24} + c_{14}c_{23}.
\]


\section*{Стайн}

TODO: 
добавить про лемму Стайна и \url{https://math.stackexchange.com/questions/3507099}

\[
\E(X g(X)) = \mu \E(g(X)) + \sigma^2 \E(g'(X)).
\]
\url{https://yedizhang.github.io/Isserlis.html}

TODO: добавить первым элегантное доказательство


Заметим, что формулы Иссерлиса в общем случае не верны для других случайных величин.
Например, подбросим правильную монетку два раза. 
Величина $X_1$ — индикатор того, что в первый раз выпал орёл,
$X_2$ — индикатор того, что во второй раз выпал орёл,
а $X_3$ — индикатор того, что результаты двух бросков совпали.
Все ожидания равны $\mu_1 = \mu_2 = \mu_3 = 1/2$.
Величины $X_1$, $X_2$ и $X_3$ попарно независимы,
поэтому все ковариации равны нулю, $c_{12} = c_{23} = c_{13} = 0$.
Однако зависимы в совокупности,
$\E(X_1 X_2 X_3) = \E(X_1 X_2) = 1/4$.
И формула Иссерлиса не верна,
\[
1/4 = \E(X_1 X_2 X_3) \neq \mu_1 \mu_2 \mu_3 + \mu_1 c_{23} + \mu_2 c_{13} + \mu_3 c_{12} = 1/8.
\]

TODO: добавить, что верно обобщение на кумулянты

\url{https://stats.stackexchange.com/questions/616234}


\end{document}

